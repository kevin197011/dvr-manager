<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DVR ç‚¹æ’­ç³»ç»Ÿ</title>
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <link rel="alternate icon" href="/favicon.ico">
    <link rel="apple-touch-icon" href="/favicon-192.png">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 30px 20px;
            margin: 0;
        }
        .container {
            background: white;
            border-radius: 16px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            padding: 40px 50px;
            max-width: 1400px;
            width: 100%;
            margin: 0 auto;
        }
        h1 {
            color: #333;
            margin-bottom: 35px;
            text-align: center;
            font-size: 32px;
            font-weight: 700;
        }
        .input-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 10px;
            color: #333;
            font-weight: 600;
            font-size: 17px;
        }
        textarea {
            width: 100%;
            padding: 16px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 15px;
            transition: border-color 0.3s;
            min-height: 100px;
            resize: vertical;
            font-family: monospace;
            line-height: 1.6;
        }
        textarea:focus {
            outline: none;
            border-color: #667eea;
        }
        button {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        button:hover {
            transform: translateY(-2px);
        }
        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        .message {
            margin-top: 20px;
            padding: 16px 20px;
            border-radius: 8px;
            display: none;
            font-size: 16px;
            font-weight: 500;
        }
        .message.success {
            background: #d4edda;
            color: #155724;
            border: 2px solid #c3e6cb;
        }
        .message.error {
            background: #f8d7da;
            color: #721c24;
            border: 2px solid #f5c6cb;
        }
        .video-container {
            margin-top: 35px;
            display: none;
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 8px 24px rgba(0,0,0,0.12);
        }
        .video-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px 24px;
        }
        .video-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .video-label {
            color: rgba(255,255,255,0.9);
            font-size: 14px;
            font-weight: 500;
        }
        .video-id {
            background: rgba(255,255,255,0.2);
            color: white;
            padding: 8px 16px;
            border-radius: 6px;
            font-family: monospace;
            font-size: 16px;
            font-weight: 600;
            letter-spacing: 0.5px;
        }
        video {
            width: 100%;
            max-height: 700px;
            display: block;
            background: #000;
        }
        .video-actions {
            padding: 20px 24px;
            background: #f8f9fa;
            display: flex;
            gap: 12px;
        }
        .action-btn {
            flex: 1;
            padding: 14px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.2s;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .action-btn:active {
            transform: translateY(0);
        }
        .action-btn.primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .action-btn.primary:hover {
            box-shadow: 0 4px 16px rgba(102, 126, 234, 0.4);
        }
        .action-btn.success {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
        }
        .action-btn.success:hover {
            box-shadow: 0 4px 16px rgba(56, 239, 125, 0.4);
        }
        .action-btn svg {
            width: 18px;
            height: 18px;
        }
        .results-container {
            margin-top: 35px;
            display: none;
        }
        .results-container h3 {
            font-size: 24px;
            color: #333;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 3px solid #667eea;
        }
        .result-item {
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 10px;
            background: #f8f9fa;
            border-left: 5px solid #667eea;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .result-item:hover {
            transform: translateX(5px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .result-item.found {
            border-left-color: #38ef7d;
            background: #e8f5e9;
        }
        .result-item.not-found {
            border-left-color: #dc3545;
            background: #ffebee;
        }
        .result-item strong {
            display: block;
            margin-bottom: 8px;
            font-size: 18px;
            color: #333;
        }
        .result-item a {
            color: #667eea;
            text-decoration: none;
            word-break: break-all;
            font-size: 13px;
            display: block;
            margin-bottom: 10px;
        }
        .result-item a:hover {
            text-decoration: underline;
        }
        .result-item button {
            width: auto;
            padding: 10px 24px;
            font-size: 15px;
            border-radius: 6px;
        }
        .result-item .video-player-inline {
            margin-top: 15px;
            display: none;
        }
        .result-item .video-player-inline.active {
            display: block;
        }
        .result-item .video-player-inline video {
            width: 100%;
            max-height: 600px;
            border-radius: 8px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.2);
        }
        .result-item .video-title-inline {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 16px;
            border-radius: 8px 8px 0 0;
            font-weight: 600;
            font-size: 16px;
        }
        .loading {
            text-align: center;
            color: #667eea;
            margin-top: 15px;
            display: none;
            font-size: 16px;
            font-weight: 500;
        }
        .loading::after {
            content: '...';
            animation: dots 1.5s steps(4, end) infinite;
        }
        @keyframes dots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60%, 100% { content: '...'; }
        }
        
        /* ç³»ç»ŸçŠ¶æ€æ  */
        .system-status {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-top: 2px solid #667eea;
            padding: 12px 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 40px;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            z-index: 1000;
            font-size: 13px;
        }
        .status-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .status-label {
            color: #666;
            font-weight: 500;
        }
        .status-value {
            color: #333;
            font-weight: 600;
            font-family: monospace;
        }
        .status-dot {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #38ef7d;
            margin-right: 5px;
            animation: pulse 2s ease-in-out infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        /* ä¸ºä¸»å®¹å™¨æ·»åŠ åº•éƒ¨é—´è·ï¼Œé¿å…è¢«çŠ¶æ€æ é®æŒ¡ */
        body {
            padding-bottom: 60px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ“¹ DVR ç‚¹æ’­ç³»ç»Ÿ</h1>
        
        <div class="input-group">
            <label for="recordId">å½•åƒç¼–å·ï¼š</label>
            <textarea id="recordId" placeholder="æ”¯æŒå¤šç§æ ¼å¼ï¼š
1. å•ä¸ªï¼šGT03225A120DV
2. é€—å·åˆ†éš”ï¼šGT03225A120DV,GT03225A120DW
3. æ¢è¡Œåˆ†éš”ï¼šæ¯è¡Œä¸€ä¸ªç¼–å·
4. è¿ç»­è¾“å…¥ï¼šGT03225A120DVGT03225A120DWGT03225A120DXï¼ˆè‡ªåŠ¨è¯†åˆ«ï¼‰"></textarea>
        </div>
        
        <button id="queryBtn" onclick="handleQuery()">æŸ¥è¯¢æ’­æ”¾</button>
        
        <div class="loading" id="loading">æ­£åœ¨æŸ¥æ‰¾å½•åƒ...</div>
        
        <div class="message" id="message"></div>
        
        <div class="video-container" id="videoContainer">
            <div class="video-header">
                <div class="video-info">
                    <span class="video-label">æ­£åœ¨æ’­æ”¾</span>
                    <span class="video-id" id="currentRecordId"></span>
                </div>
            </div>
            <video id="videoPlayer" controls>
                æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè§†é¢‘æ’­æ”¾ã€‚
            </video>
            <div class="video-actions">
                <button id="playPauseBtn" class="action-btn primary">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M8 5v14l11-7z"/>
                    </svg>
                    <span>æ’­æ”¾</span>
                </button>
                <button id="downloadVideoBtn" class="action-btn success">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                        <polyline points="7 10 12 15 17 10"></polyline>
                        <line x1="12" y1="15" x2="12" y2="3"></line>
                    </svg>
                    <span>ä¸‹è½½</span>
                </button>
            </div>
        </div>

        <div class="results-container" id="resultsContainer">
            <h3 style="margin-bottom: 15px;">æŸ¥è¯¢ç»“æœ</h3>
            <div id="resultsList"></div>
        </div>
    </div>

    <!-- ç³»ç»Ÿè¿è¡ŒçŠ¶æ€ -->
    <div class="system-status">
        <div class="status-item">
            <span class="status-label">ç³»ç»ŸçŠ¶æ€</span>
            <span class="status-value" id="systemStatus">
                <span class="status-dot"></span>è¿è¡Œä¸­
            </span>
        </div>
        <div class="status-item">
            <span class="status-label">DVR æœåŠ¡å™¨</span>
            <span class="status-value" id="dvrCount">åŠ è½½ä¸­...</span>
        </div>
        <div class="status-item">
            <span class="status-label">è¿è¡Œæ—¶é•¿</span>
            <span class="status-value" id="uptime">00:00:00</span>
        </div>
        <div class="status-item">
            <span class="status-label">æŸ¥è¯¢æ¬¡æ•°</span>
            <span class="status-value" id="queryCount">0</span>
        </div>
    </div>

    <script>
        // ä½¿ç”¨ç›¸å¯¹è·¯å¾„ï¼Œè‡ªåŠ¨é€‚é…å½“å‰åŸŸåå’Œç«¯å£
        const API_URL = '/api/play';
        const HEALTH_URL = '/health';
        let currentPlayingVideo = null; // è®°å½•å½“å‰æ­£åœ¨æ’­æ”¾çš„è§†é¢‘
        let queryCount = 0; // æŸ¥è¯¢æ¬¡æ•°ç»Ÿè®¡
        let startTime = Date.now(); // é¡µé¢åŠ è½½æ—¶é—´

        // è§£æå½•åƒç¼–å·ï¼Œæ”¯æŒå¤šç§æ ¼å¼
        function parseRecordIds(input) {
            // å…ˆå°è¯•æŒ‰é€—å·æˆ–æ¢è¡Œåˆ†å‰²
            let ids = input.split(/[,\n\r]+/).map(id => id.trim()).filter(id => id);
            
            // å¦‚æœåªæœ‰ä¸€ä¸ªç»“æœï¼Œæ£€æŸ¥æ˜¯å¦æ˜¯è¿ç»­è¾“å…¥çš„æ ¼å¼ï¼ˆå¦‚ GT03225A120DVGT03225A120DWï¼‰
            if (ids.length === 1 && ids[0].length > 14) {
                const continuous = ids[0];
                // å°è¯•æŒ‰å›ºå®šé•¿åº¦åˆ†å‰²ï¼ˆå‡è®¾æ¯ä¸ªç¼–å·14ä¸ªå­—ç¬¦ï¼‰
                const matches = continuous.match(/.{14}/g);
                if (matches && matches.length > 1) {
                    ids = matches;
                }
            }
            
            return ids;
        }

        async function handleQuery() {
            const input = document.getElementById('recordId').value.trim();
            
            if (!input) {
                showMessage('è¯·è¾“å…¥å½•åƒç¼–å·', 'error');
                return;
            }

            const recordIds = parseRecordIds(input);
            
            if (recordIds.length === 0) {
                showMessage('è¯·è¾“å…¥æœ‰æ•ˆçš„å½•åƒç¼–å·', 'error');
                return;
            }

            // å•ä¸ªæˆ–å¤šä¸ª
            if (recordIds.length === 1) {
                await playSingleVideo(recordIds[0]);
            } else {
                await batchQuery(recordIds);
            }
        }

        async function playSingleVideo(recordId) {
            const messageEl = document.getElementById('message');
            const videoContainer = document.getElementById('videoContainer');
            const resultsContainer = document.getElementById('resultsContainer');
            const videoPlayer = document.getElementById('videoPlayer');
            const queryBtn = document.getElementById('queryBtn');
            const loading = document.getElementById('loading');

            // é‡ç½®çŠ¶æ€
            messageEl.style.display = 'none';
            videoContainer.style.display = 'none';
            resultsContainer.style.display = 'none';
            
            // åœæ­¢æ‰¹é‡æŸ¥è¯¢ä¸­çš„è§†é¢‘
            stopAllBatchVideos();

            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            queryBtn.disabled = true;
            loading.style.display = 'block';

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ record_id: recordId })
                });

                const data = await response.json();

                // æ›´æ–°æŸ¥è¯¢æ¬¡æ•°
                incrementQueryCount(1);

                if (data.success && data.proxy_url) {
                    showMessage('å½•åƒæ‰¾åˆ°ï¼æ­£åœ¨åŠ è½½...', 'success');
                    document.getElementById('currentRecordId').textContent = recordId;
                    videoPlayer.src = data.proxy_url;
                    videoContainer.style.display = 'block';
                    videoPlayer.play();
                    
                    // è®¾ç½®æ’­æ”¾/æš‚åœæŒ‰é’®
                    const playPauseBtn = document.getElementById('playPauseBtn');
                    const updatePlayPauseBtn = function() {
                        if (videoPlayer.paused) {
                            playPauseBtn.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg><span>æ’­æ”¾</span>';
                        } else {
                            playPauseBtn.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><rect x="6" y="4" width="4" height="16"></rect><rect x="14" y="4" width="4" height="16"></rect></svg><span>æš‚åœ</span>';
                        }
                    };
                    
                    playPauseBtn.onclick = function() {
                        if (videoPlayer.paused) {
                            videoPlayer.play();
                        } else {
                            videoPlayer.pause();
                        }
                        updatePlayPauseBtn();
                    };
                    
                    // ç›‘å¬è§†é¢‘æ’­æ”¾çŠ¶æ€å˜åŒ–
                    videoPlayer.onplay = updatePlayPauseBtn;
                    videoPlayer.onpause = updatePlayPauseBtn;
                    videoPlayer.onended = updatePlayPauseBtn;
                    
                    // åˆå§‹åŒ–æŒ‰é’®çŠ¶æ€
                    updatePlayPauseBtn();
                    
                    // è®¾ç½®ä¸‹è½½æŒ‰é’®
                    const downloadBtn = document.getElementById('downloadVideoBtn');
                    downloadBtn.onclick = function() {
                        const link = document.createElement('a');
                        link.href = data.proxy_url;
                        link.download = recordId + '.mp4';
                        link.style.display = 'none';
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                        showMessage('å¼€å§‹ä¸‹è½½: ' + recordId, 'success');
                    };
                } else {
                    showMessage(data.message || 'æœªæ‰¾åˆ°å½•åƒ', 'error');
                }
            } catch (error) {
                showMessage('è¯·æ±‚å¤±è´¥ï¼š' + error.message, 'error');
            } finally {
                queryBtn.disabled = false;
                loading.style.display = 'none';
            }
        }

        async function batchQuery(recordIds) {
            const messageEl = document.getElementById('message');
            const videoContainer = document.getElementById('videoContainer');
            const resultsContainer = document.getElementById('resultsContainer');
            const resultsList = document.getElementById('resultsList');
            const queryBtn = document.getElementById('queryBtn');
            const loading = document.getElementById('loading');

            // é‡ç½®çŠ¶æ€
            messageEl.style.display = 'none';
            videoContainer.style.display = 'none';
            resultsContainer.style.display = 'none';
            resultsList.innerHTML = '';
            
            // åœæ­¢å•ä¸ªè§†é¢‘æ’­æ”¾å™¨
            const singleVideoPlayer = document.getElementById('videoPlayer');
            if (singleVideoPlayer) {
                singleVideoPlayer.pause();
                singleVideoPlayer.src = '';
            }
            
            // é‡ç½®å½“å‰æ’­æ”¾çŠ¶æ€
            currentPlayingVideo = null;

            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            queryBtn.disabled = true;
            loading.style.display = 'block';

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ record_ids: recordIds })
                });

                const data = await response.json();

                // æ›´æ–°æŸ¥è¯¢æ¬¡æ•°ï¼ˆæ‰¹é‡æŸ¥è¯¢ç®—å¤šæ¬¡ï¼‰
                incrementQueryCount(recordIds.length);

                if (data.success && data.results) {
                    showMessage(`æŸ¥è¯¢å®Œæˆï¼æ‰¾åˆ° ${data.results.filter(r => r.found).length}/${data.results.length} ä¸ªå½•åƒ`, 'success');
                    
                    // æ˜¾ç¤ºç»“æœ
                    data.results.forEach((result, index) => {
                        const item = document.createElement('div');
                        item.className = 'result-item ' + (result.found ? 'found' : 'not-found');
                        
                        if (result.found) {
                            const strong = document.createElement('strong');
                            strong.textContent = 'âœ“ ' + result.record_id;
                            
                            const info = document.createElement('div');
                            info.style.cssText = 'color: #666; font-size: 12px; margin-top: 5px;';
                            info.textContent = 'æ’­æ”¾åœ°å€: ' + result.proxy_url;
                            
                            // åˆ›å»ºæŒ‰é’®å®¹å™¨
                            const btnContainer = document.createElement('div');
                            btnContainer.style.cssText = 'margin-top: 10px; display: flex; gap: 10px;';
                            
                            // æ’­æ”¾æŒ‰é’®
                            const playBtn = document.createElement('button');
                            playBtn.type = 'button';
                            playBtn.className = 'play-btn-' + index;
                            playBtn.style.cssText = 'padding: 10px 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 6px; cursor: pointer; flex: 1; font-weight: 600; font-size: 15px; transition: all 0.2s; box-shadow: 0 2px 4px rgba(102, 126, 234, 0.3);';
                            playBtn.innerHTML = '<svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor" style="vertical-align: middle; margin-right: 6px;"><path d="M8 5v14l11-7z"/></svg>æ’­æ”¾';
                            
                            // ä¸‹è½½æŒ‰é’®
                            const downloadBtn = document.createElement('button');
                            downloadBtn.type = 'button';
                            downloadBtn.style.cssText = 'padding: 10px 20px; background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); color: white; border: none; border-radius: 6px; cursor: pointer; flex: 1; font-weight: 600; font-size: 15px; transition: all 0.2s; box-shadow: 0 2px 4px rgba(56, 239, 125, 0.3);';
                            downloadBtn.innerHTML = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align: middle; margin-right: 6px;"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>ä¸‹è½½';
                            
                            // æŒ‰é’®æ‚¬åœæ•ˆæœ
                            playBtn.onmouseenter = function() {
                                this.style.transform = 'translateY(-2px)';
                                this.style.boxShadow = '0 4px 12px rgba(102, 126, 234, 0.4)';
                            };
                            playBtn.onmouseleave = function() {
                                this.style.transform = 'translateY(0)';
                                this.style.boxShadow = '0 2px 4px rgba(102, 126, 234, 0.3)';
                            };
                            
                            downloadBtn.onmouseenter = function() {
                                this.style.transform = 'translateY(-2px)';
                                this.style.boxShadow = '0 4px 12px rgba(56, 239, 125, 0.4)';
                            };
                            downloadBtn.onmouseleave = function() {
                                this.style.transform = 'translateY(0)';
                                this.style.boxShadow = '0 2px 4px rgba(56, 239, 125, 0.3)';
                            };
                            
                            // åˆ›å»ºå†…è”è§†é¢‘æ’­æ”¾å™¨å®¹å™¨
                            const videoContainer = document.createElement('div');
                            videoContainer.className = 'video-player-inline';
                            videoContainer.id = 'video-container-' + index;
                            
                            const videoTitle = document.createElement('div');
                            videoTitle.className = 'video-title-inline';
                            videoTitle.textContent = 'æ­£åœ¨æ’­æ”¾ï¼š' + result.record_id;
                            
                            const video = document.createElement('video');
                            video.controls = true;
                            video.id = 'video-player-' + index;
                            video.style.display = 'block';
                            
                            videoContainer.appendChild(videoTitle);
                            videoContainer.appendChild(video);
                            
                            // ä½¿ç”¨ç«‹å³æ‰§è¡Œå‡½æ•°åˆ›å»ºé—­åŒ…
                            (function(proxyUrl, videoId, videoIndex) {
                                playBtn.onclick = function(e) {
                                    e.preventDefault();
                                    e.stopPropagation();
                                    console.log('ç‚¹å‡»æ’­æ”¾æŒ‰é’® #' + videoIndex + ':', videoId, proxyUrl);
                                    
                                    const container = document.getElementById('video-container-' + videoIndex);
                                    const player = document.getElementById('video-player-' + videoIndex);
                                    
                                    if (container.classList.contains('active')) {
                                        // å¦‚æœå·²ç»æ˜¾ç¤ºï¼Œåˆ™éšè—
                                        container.classList.remove('active');
                                        player.pause();
                                        player.src = '';
                                        playBtn.innerHTML = '<svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor" style="vertical-align: middle; margin-right: 6px;"><path d="M8 5v14l11-7z"/></svg>æ’­æ”¾';
                                        currentPlayingVideo = null;
                                    } else {
                                        // å…ˆåœæ­¢ä¹‹å‰æ­£åœ¨æ’­æ”¾çš„è§†é¢‘
                                        if (currentPlayingVideo !== null && currentPlayingVideo !== videoIndex) {
                                            const prevContainer = document.getElementById('video-container-' + currentPlayingVideo);
                                            const prevPlayer = document.getElementById('video-player-' + currentPlayingVideo);
                                            const prevBtn = document.querySelector('.play-btn-' + currentPlayingVideo);
                                            
                                            if (prevContainer && prevPlayer) {
                                                prevContainer.classList.remove('active');
                                                prevPlayer.pause();
                                                prevPlayer.src = '';
                                                if (prevBtn) {
                                                    prevBtn.innerHTML = '<svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor" style="vertical-align: middle; margin-right: 6px;"><path d="M8 5v14l11-7z"/></svg>æ’­æ”¾';
                                                }
                                            }
                                        }
                                        
                                        // æ˜¾ç¤ºå¹¶æ’­æ”¾æ–°è§†é¢‘
                                        container.classList.add('active');
                                        player.src = proxyUrl;
                                        player.load();
                                        player.play().then(() => {
                                            console.log('è§†é¢‘å¼€å§‹æ’­æ”¾:', videoId);
                                            playBtn.innerHTML = '<svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor" style="vertical-align: middle; margin-right: 6px;"><rect x="6" y="4" width="4" height="16"></rect><rect x="14" y="4" width="4" height="16"></rect></svg>åœæ­¢';
                                            currentPlayingVideo = videoIndex;
                                        }).catch(err => {
                                            console.error('æ’­æ”¾å¤±è´¥:', err);
                                            showMessage('æ’­æ”¾å¤±è´¥: ' + err.message, 'error');
                                        });
                                    }
                                    
                                    return false;
                                };
                            })(result.proxy_url, result.record_id, index);
                            
                            // ä¸‹è½½æŒ‰é’®ç‚¹å‡»äº‹ä»¶
                            (function(proxyUrl, videoId) {
                                downloadBtn.onclick = function(e) {
                                    e.preventDefault();
                                    e.stopPropagation();
                                    console.log('ä¸‹è½½è§†é¢‘:', videoId, proxyUrl);
                                    
                                    // åˆ›å»ºéšè—çš„ a æ ‡ç­¾è§¦å‘ä¸‹è½½
                                    const link = document.createElement('a');
                                    link.href = proxyUrl;
                                    link.download = videoId + '.mp4';
                                    link.style.display = 'none';
                                    document.body.appendChild(link);
                                    link.click();
                                    document.body.removeChild(link);
                                    
                                    showMessage('å¼€å§‹ä¸‹è½½: ' + videoId, 'success');
                                    return false;
                                };
                            })(result.proxy_url, result.record_id);
                            
                            btnContainer.appendChild(playBtn);
                            btnContainer.appendChild(downloadBtn);
                            
                            item.appendChild(strong);
                            item.appendChild(info);
                            item.appendChild(btnContainer);
                            item.appendChild(videoContainer);
                        } else {
                            const strong = document.createElement('strong');
                            strong.textContent = 'âœ— ' + result.record_id;
                            
                            const span = document.createElement('span');
                            span.style.color = '#721c24';
                            span.textContent = 'æœªæ‰¾åˆ°';
                            span.style.marginLeft = '10px';
                            
                            item.appendChild(strong);
                            item.appendChild(span);
                        }
                        
                        resultsList.appendChild(item);
                    });
                    
                    resultsContainer.style.display = 'block';
                } else {
                    showMessage(data.message || 'æŸ¥è¯¢å¤±è´¥', 'error');
                }
            } catch (error) {
                showMessage('è¯·æ±‚å¤±è´¥ï¼š' + error.message, 'error');
            } finally {
                queryBtn.disabled = false;
                loading.style.display = 'none';
            }
        }

        // åœæ­¢æ‰€æœ‰æ‰¹é‡æŸ¥è¯¢ä¸­çš„è§†é¢‘
        function stopAllBatchVideos() {
            if (currentPlayingVideo !== null) {
                const prevContainer = document.getElementById('video-container-' + currentPlayingVideo);
                const prevPlayer = document.getElementById('video-player-' + currentPlayingVideo);
                const prevBtn = document.querySelector('.play-btn-' + currentPlayingVideo);
                
                if (prevContainer && prevPlayer) {
                    prevContainer.classList.remove('active');
                    prevPlayer.pause();
                    prevPlayer.src = '';
                    if (prevBtn) {
                        prevBtn.textContent = 'æ’­æ”¾';
                    }
                }
                currentPlayingVideo = null;
            }
        }

        function showMessage(text, type) {
            const messageEl = document.getElementById('message');
            messageEl.textContent = text;
            messageEl.className = 'message ' + type;
            messageEl.style.display = 'block';
        }

        // æ”¯æŒå›è½¦é”®æäº¤
        document.getElementById('recordId').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                handleQuery();
            }
        });

        // ç³»ç»ŸçŠ¶æ€æ›´æ–°
        async function updateSystemStatus() {
            try {
                const response = await fetch(HEALTH_URL);
                const data = await response.json();
                
                if (data.status === 'ok') {
                    document.getElementById('systemStatus').innerHTML = 
                        '<span class="status-dot"></span>è¿è¡Œä¸­';
                    document.getElementById('dvrCount').textContent = 
                        data.dvr_servers + ' ä¸ª';
                } else {
                    document.getElementById('systemStatus').innerHTML = 
                        '<span class="status-dot" style="background: #dc3545;"></span>å¼‚å¸¸';
                }
            } catch (error) {
                document.getElementById('systemStatus').innerHTML = 
                    '<span class="status-dot" style="background: #ffc107;"></span>ç¦»çº¿';
                console.error('å¥åº·æ£€æŸ¥å¤±è´¥:', error);
            }
        }

        // åŠ è½½ç³»ç»Ÿé…ç½®
        async function loadSystemConfig() {
            try {
                const response = await fetch('/api/config');
                const config = await response.json();
                console.log('ç³»ç»Ÿé…ç½®:', config);
                // å¯ä»¥åœ¨è¿™é‡Œä½¿ç”¨é…ç½®ä¿¡æ¯
            } catch (error) {
                console.error('åŠ è½½é…ç½®å¤±è´¥:', error);
            }
        }

        // æ›´æ–°è¿è¡Œæ—¶é•¿
        function updateUptime() {
            const elapsed = Date.now() - startTime;
            const hours = Math.floor(elapsed / 3600000);
            const minutes = Math.floor((elapsed % 3600000) / 60000);
            const seconds = Math.floor((elapsed % 60000) / 1000);
            
            document.getElementById('uptime').textContent = 
                `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        }

        // æ›´æ–°æŸ¥è¯¢æ¬¡æ•°
        function incrementQueryCount(count = 1) {
            queryCount += count;
            document.getElementById('queryCount').textContent = queryCount;
        }

        // åˆå§‹åŒ–ç³»ç»ŸçŠ¶æ€
        loadSystemConfig();
        updateSystemStatus();
        setInterval(updateSystemStatus, 30000); // æ¯30ç§’æ›´æ–°ä¸€æ¬¡å¥åº·çŠ¶æ€
        setInterval(updateUptime, 1000); // æ¯ç§’æ›´æ–°è¿è¡Œæ—¶é•¿
    </script>
</body>
</html>
